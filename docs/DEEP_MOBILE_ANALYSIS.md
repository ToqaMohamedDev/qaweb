# تحليل عميق للمشاكل التقنية على الموبايل (Deep Technical Analysis)

بعد مراجعة الكود بدقة (خاصة `Navbar.tsx` و `useAuthStore.ts` و `middleware.ts`)، تبين أن المشكلتين (فشل تحميل المراحل + فشل تسجيل الخروج) مرتبطتان ببعضهما البعض بشكل وثيق جداً.

السبب ليس مجرد "مشكلة شبكة"، بل هو **خطأ في تسلسل العمليات البرمجية (Race Condition)** يؤدي إلى حالة "المستخدم الزومبي" (Zombie Session).

---

## 1. لغز "تسجيل الخروج" (The Phantom Logout)
**الملاحظة:** تضغط على "تسجيل الخروج"، القائمة تختفي أو تتغير، لكنك تظل مسجلاً للدخول فعلياً أو تواجه مشاكل بعدها.

### التحليل التقني الدقيق:
في ملف `components/Navbar.tsx`، دالة `handleSignOut` تحتوي على خطأ قاتل في التسلسل:

```typescript
const handleSignOut = useCallback(async () => {
    // 1. تدمير الحالة محلياً وفوراً
    useAuthStore.getState().reset(); 
    
    // 2. محاولة تحميل مكتبة Supabase وبدء عملية الخروج (غير متزامنة)
    try {
        const { signOut } = await import('@/lib/supabase'); // Dynamic Import
        await signOut();
    } catch { ... }

    // 3. مسح الكوكيز من السيرفر
    await fetch('/api/auth/logout', ...);
    
    // 4. التوجيه وإغلاق القائمة
    router.push('/login');
    setIsMobileMenuOpen(false);
}, ...);
```

**لماذا يفشل هذا على الموبايل تحديداً؟**
1.  عند تنفيذ الخطوة **(1)**: يتم مسح بيانات المستخدم من الذاكرة (`user = null`).
2.  **رد فعل React الفوري:** يتم إعادة رسم (Re-render) المكون `MobileMenu`. بما أن `user` أصبح `null`، يختفي زر "تسجيل الخروج" من الشاشة ويحل محله زر "تسجيل الدخول".
3.  **انقطاع التنفيذ:** على متصفحات الموبايل (خاصة Safari iOS و Chrome Android)، عندما يتم إزالة العنصر الذي أطلق الحدث (الزر) من الـ DOM *أثناء* معالجة الحدث، وبوجود عملية `await import` (تحميل ملف عبر الشبكة)، غالباً ما يقوم المتصفح بإلغاء أو "تجميد" العمليات المتبقية لتوفير الموارد، خاصة إذا انتقل المتصفح لحالة "Idle".
4.  **النتيجة الكارثية:** 
    *   الواجهة تقول أنك "خرجت" (لأن الـ Store فارغ).
    *   لكن **LocalStorage** (في المتصفح) و **Cookies** (في السيرفر) ما زالت تحتوي على التوكن القديم!

---

## 2. لغز "عدم تحميل المراحل" (The Zombie Session Block)
**الملاحظة:** عند الدخول لصفحة إنشاء حساب جديد، المراحل لا تظهر.

### التحليل التقني الدقيق:
هذه المشكلة هي **عَرَض جانبي** للمشكلة الأولى.

1.  المستخدم (أنت) حاول تسجيل الخروج سابقاً وفشلت العملية "خفياً" كما شرحنا أعلاه.
2.  بقي في ذاكرة المتصفح (`LocalStorage`) توكن مستخدم قديم أو منتهي الصلاحية (Invalid Token).
3.  عند دخول صفحة `signup`، الكود يستدعي:
    ```typescript
    const supabase = createClient();
    // يقوم Supabase تلقائياً باستعادة التوكن "الفاسد" من الذاكرة
    ```
4.  الكود يحاول جلب المراحل:
    ```typescript
    .from('educational_stages').select(...)
    ```
5.  **المفاجأة:** بما أن `createClient` وجد توكن، فإنه يرسله مع الطلب. قاعدة البيانات ترفض الطلب لأن التوكن "فاسد" أو ليس له صلاحية، فتعود بـ `401 Unauthorized` أو `403 Forbidden` بدلاً من معاملة المستخدم كـ "زائر" (Anon).
    *   على الكمبيوتر: غالباً التوكن سليم أو تم مسحه بنجاح، فيعمل الطلب كـ Anon وينجح.
    *   على الموبايل: التوكن "العالق" يفسد الطلب.

---

## الخلاصة (Conclusion)
المشكلة ليست في "السيرفر" ولا "الشبكة"، بل في أن **كود تسجيل الخروج يقتل الزر قبل أن يقتل الجلسة**.

*   **على الكمبيوتر:** المعالج (CPU) والشبكة أسرع، فيلحق الكود تنفيذ `signOut` قبل أن يلاحظ المتصفح اختفاء الزر.
*   **على الموبايل:** التأخير في الشبكة (لتحميل `import`) مع صرامة المتصفح في إدارة الذاكرة يؤدي لفشل العملية وبقاء "بقايا" الجلسة التي تمنع تحميل البيانات لاحقاً.

 هذا التقرير يشرح السبب الجذري بعمق دون الحاجة لتغيير الكود الآن.
