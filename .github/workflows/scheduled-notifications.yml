name: Send Scheduled Notifications

# ØªØ´ØºÙŠÙ„ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
on:
  schedule:
    - cron: '*/5 * * * *'  # ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
  workflow_dispatch:  # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù…Ù† GitHub UI

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: Call Supabase Edge Function
        run: |
          response=$(curl -X POST '${{ secrets.SUPABASE_URL }}/functions/v1/send-scheduled-notifications' \
            -H 'Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}' \
            -H 'Content-Type: application/json' \
            -w "\nHTTP_STATUS:%{http_code}" \
            -s)
          
          http_code=$(echo "$response" | grep "HTTP_STATUS" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_STATUS/d')
          
          echo "Response: $body"
          echo "HTTP Status: $http_code"
          
          if [ "$http_code" != "200" ]; then
            echo "âŒ Error: Function returned status $http_code"
            exit 1
          fi
          
          echo "âœ… Scheduled notifications sent successfully"
      
      - name: Log Success
        if: success()
        run: |
          echo "ğŸ“§ Notification job completed at $(date)"
      
      - name: Log Failure
        if: failure()
        run: |
          echo "âŒ Notification job failed at $(date)"
